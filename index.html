<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Retaped</title>
</head>

<body>
    <h1>Retaped</h1>
    <h4>The revolt.chat client re-taped from the one that's held together by duct tape and bad code</h4>
    <br />
    <div id="loginoe">
        <input id="token" alt="aaa" placeholder="Token">
        <br><input id="channel" placeholder="Channel ID">
        <br><input id="inputTheme" placeholder="Theme">
        <br><button onclick="login()">ok</button>
        <br /><br /><br />
    </div>
    <div id="logged" hidden="true">
        <button onclick="getmessage()">Get messages</button>
        <button onclick="embedmessage()">Send embed</button>
        <br>
        <input type="text" style="width: 90%;" autocomplete="off" placeholder="Title" id="title" hidden="true" />
        <input type="text" style="width: 90%;" autocomplete="off" placeholder="Description" id="desc" hidden="true" />
        <input type="text" style="width: 90%;" autocomplete="off" placeholder="Color" id="color" hidden="true" />
        <button onclick="contentToJson()">JSON</button>
        <input type="text" style="width: 90%;" autocomplete="off" placeholder="Speak in channel" id="a" />
        <button onclick="sendmessage()">Send</button>
        <br>
    </div>
    <h2 id="theme"></h2>
    <br />
    <div id="messages" hidden="true">
    </div>

    <style>
        .message {
            display: inline
        }

        html {
            background-color: #000000;
            color: #FFFFFF;
            font-family: monospace
        }

        img {
            max-width: 600px;
        }

        .messages {
            white-space: nowrap;
        }

        .loginoe {
            display: flex;
            align-items: center;
        }

        .message {
            text-align: left
        }

        h5 {
            border-style: solid;
            border-width: 1px;
        }
    </style>

    <script>
        let embedSend = false;
        let sendRawJson = false;
        let uIDs = [];
        let usernames = [];
        function embedmessage() {
            document.getElementById("title").hidden = false;
            document.getElementById("desc").hidden = false;
            document.getElementById("color").hidden = false;
            embedSend = true;
        }
        document.getElementById("a").onkeypress = function (event) {
            if (event.keyCode == 13 || event.which == 13) {
                sendmessage();
            }
        };
        function contentToJson() {
            if (!sendRawJson) {
                sendRawJson = true;
            }
            else { sendRawJson = false; }
        }
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        async function login() {
            for (let i = 1; i < 51; i++) {
                document.getElementById("messages").innerHTML += `<h6 id="a${i}reply" hidden=true>reply</h6><div id="message"><h4 id="a${i}">author </h4>
                    <h5 id = "${i}msg" > message</h5 ></div>`
            }
            var theme
            thetoken = document.getElementById("token").value;
            thechannel = document.getElementById("channel").value;
            document.getElementById("loginoe").hidden = true;
            document.getElementById("logged").hidden = false;
            //if (!document.getElementById("inputTheme").value == '') { document.cookie = `theme=${document.getElementById("inputTheme").value};` }
            //if (document.cookie) { let theme = document.cookie.split('; ').find(row => row.startsWith('theme=')).split('=')[1]; }
            theme = document.getElementById("inputTheme").value
            document.getElementById("theme").innerHTML = theme;
            getmessage();
            while (1) { await sleep(7000); getmessage() }
        }

        async function sendmessage() {
            if (!(embedSend || sendRawJson)) {
                await fetch("https://api.revolt.chat/channels/" + thechannel + "/messages", {
                    "credentials": "omit",
                    "headers": {
                        "Accept": "*/*",
                        "Content-Type": "application/json",
                        "x-session-token": thetoken
                    },
                    "body": `{
                        "content":"${document.getElementById("a").value}"
                    }`,
                    "method": "POST"
                })
                document.getElementById("a").value = ""
            }
            else {
                if (embedSend) {
                    await fetch("https://api.revolt.chat/channels/" + thechannel + "/messages", {
                        "credentials": "omit",
                        "headers": {
                            "Accept": "*/*",
                            "Content-Type": "application/json",
                            "x-session-token": thetoken
                        },
                        "body": `{
                        "nonce":"",
                        "content":"${document.getElementById("a").value}",
                        "embeds":[
                            {
                                "title":"${document.getElementById("title").value}",
                                "description":"${document.getElementById("desc").value}",
                                "colour":"${document.getElementById("color").value}"
                            }
                        ]
                    }`,
                        "method": "POST"
                    })
                    embedSend = false;
                    document.getElementById("title").hidden = true;
                    document.getElementById("desc").hidden = true;
                    document.getElementById("color").hidden = true;
                    document.getElementById("title").value = "";
                    document.getElementById("desc").value = "";
                    document.getElementById("color").value = "";
                }
                else {
                    await fetch("https://api.revolt.chat/channels/" + thechannel + "/messages", {
                        "credentials": "omit",
                        "headers": {
                            "Accept": "*/*",
                            "Content-Type": "application/json",
                            "x-session-token": thetoken
                        },
                        "body": document.getElementById("a").value,
                        "method": "POST"
                    })
                    sendRawJson = false;
                }
            }
            getmessage();
        }
        async function replacea() {
            for (let i = 1; i < 51; i++) {
                id = document.getElementById("a" + i).innerHTML;
                if (id.search(/^[0123456789ABCDEFGHJKMNPQRSTVWXYZ]{26}/) === -1) { } else {
                    //if()
                    fetch("https://api.revolt.chat/users/" + id, {
                        "credentials": "omit",
                        "headers": {
                            "Accept": "*/*",
                            "x-session-token": thetoken
                        },
                        "method": "GET",
                    }).then(response => response.json())
                        .then(data => document.getElementById("a" + i).innerText = (data.username))
                }
            }
            document.getElementById("rplca").hidden = true;
        }
        async function getmessage() {
            document.getElementById("messages").hidden = false
            await fetch(`https://api.revolt.chat/channels/${thechannel}/messages?include_users=true`, {
                "credentials": "omit",
                "headers": {
                    "Accept": "*/*",
                    "x-session-token": thetoken
                },
                "method": "GET",
            }).then(response => response.json())
                .then(data => mess = (data.messages))
            for (let i = 1; i < 50; i++) {
                if (!mess[i - 1].masquerade) {
                    document.getElementById("a" + i).innerText = mess[i - 1].author;
                } else {
                    document.getElementById("a" + i).innerText = mess[i - 1].masquerade["name"];
                }
            }
            replacea();
            for (let i = 1; i < 50; i++) {
                mess[i - 1].content = mess[i - 1].content.replace("\n", "<br>")
                document.getElementById(`${i}msg`).innerText = mess[i - 1].content;
                if (!mess[i - 1].attachments == "") {
                    image = mess[i - 1].attachments;
                    document.getElementById(`${i}msg`).innerHTML =
                        document.getElementById(`${i}msg`).innerText +
                        `<br><br><img src="https://autumn.revolt.chat/attachments/${image[0]._id}/${image[0].filename}">`
                }
                if (!mess[i - 1].replies == "") {
                    fetch(`https://api.revolt.chat/channels/${thechannel}/messages/${mess[i - 1].replies[0]}`, {
                        "credentials": "omit",
                        "headers": {
                            "Accept": "*/*",
                            "x-session-token": thetoken
                        },
                        "method": "GET",
                    }).then(response => response.json())
                        .then(data => document.getElementById(`a${i}reply`).innerText = (`> ${data.content}`))
                    document.getElementById(`a${i}reply`).hidden = false;
                }
            }

            document.getElementById("rplca").hidden = false
        }
    </script>
</body>

</html>
